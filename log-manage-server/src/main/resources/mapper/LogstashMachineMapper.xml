<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hina.log.domain.mapper.LogstashMachineMapper">
    
    <!-- 插入 Logstash 机器记录 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO logstash_machine (logstash_process_id, machine_id, state, config_content, jvm_options, logstash_yml, create_time, update_time)
        VALUES (#{logstashProcessId}, #{machineId}, #{state}, #{configContent}, #{jvmOptions}, #{logstashYml}, NOW(), NOW())
    </insert>
    
    <!-- 更新进程 PID -->
    <update id="updateProcessPid">
        UPDATE logstash_machine SET process_pid = #{processPid}
        WHERE logstash_process_id = #{logstashProcessId} AND machine_id = #{machineId}
    </update>
    
    <!-- 更新状态 -->
    <update id="updateState">
        UPDATE logstash_machine SET state = #{state}
        WHERE logstash_process_id = #{logstashProcessId} AND machine_id = #{machineId}
    </update>
    
    <!-- 更新配置内容 -->
    <update id="updateConfigContent">
        UPDATE logstash_machine SET config_content = #{configContent}
        WHERE logstash_process_id = #{logstashProcessId} AND machine_id = #{machineId}
    </update>
    
    <!-- 更新 JVM 选项 -->
    <update id="updateJvmOptions">
        UPDATE logstash_machine SET jvm_options = #{jvmOptions}
        WHERE logstash_process_id = #{logstashProcessId} AND machine_id = #{machineId}
    </update>
    
    <!-- 更新 logstash.yml -->
    <update id="updateLogstashYml">
        UPDATE logstash_machine SET logstash_yml = #{logstashYml}
        WHERE logstash_process_id = #{logstashProcessId} AND machine_id = #{machineId}
    </update>
    
    <!-- 更新 Logstash 机器记录 -->
    <update id="update">
        UPDATE logstash_machine SET
        process_pid = #{processPid},
        state = #{state},
        config_content = #{configContent},
        jvm_options = #{jvmOptions},
        logstash_yml = #{logstashYml}
        WHERE id = #{id}
    </update>
    
    <!-- 根据 ID 删除 -->
    <delete id="deleteById">
        DELETE FROM logstash_machine WHERE id=#{id}
    </delete>
    
    <!-- 根据 Logstash 进程 ID 删除 -->
    <delete id="deleteByLogstashProcessId">
        DELETE FROM logstash_machine WHERE logstash_process_id=#{logstashProcessId}
    </delete>
    
    <!-- 根据机器 ID 删除 -->
    <delete id="deleteByMachineId">
        DELETE FROM logstash_machine WHERE machine_id=#{machineId}
    </delete>
    
    <!-- 根据 Logstash 进程 ID 查询 -->
    <select id="selectByLogstashProcessId" resultType="com.hina.log.domain.entity.LogstashMachine">
        SELECT * FROM logstash_machine WHERE logstash_process_id=#{logstashProcessId}
    </select>
    
    <!-- 根据机器 ID 查询 -->
    <select id="selectByMachineId" resultType="com.hina.log.domain.entity.LogstashMachine">
        SELECT * FROM logstash_machine WHERE machine_id=#{machineId}
    </select>
    
    <!-- 根据 Logstash 进程 ID 和机器 ID 查询 -->
    <select id="selectByLogstashProcessIdAndMachineId" resultType="com.hina.log.domain.entity.LogstashMachine">
        SELECT * FROM logstash_machine WHERE logstash_process_id=#{logstashProcessId} AND machine_id=#{machineId}
    </select>
    
    <!-- 查询所有带进程 PID 的记录 -->
    <select id="selectAllWithProcessPid" resultType="com.hina.log.domain.entity.LogstashMachine">
        SELECT * FROM logstash_machine WHERE process_pid IS NOT NULL
    </select>
    
    <!-- 根据状态查询 -->
    <select id="selectByState" resultType="com.hina.log.domain.entity.LogstashMachine">
        SELECT * FROM logstash_machine WHERE state = #{state}
    </select>
    
    <!-- 根据 Logstash 进程 ID 和状态查询 -->
    <select id="selectByLogstashProcessIdAndState" resultType="com.hina.log.domain.entity.LogstashMachine">
        SELECT * FROM logstash_machine WHERE logstash_process_id = #{logstashProcessId} AND state = #{state}
    </select>
    
    <!-- 根据 Logstash 进程 ID 和机器 ID 计数 -->
    <select id="countByLogstashProcessIdAndMachineId" resultType="int">
        SELECT COUNT(*) FROM logstash_machine WHERE logstash_process_id=#{logstashProcessId} AND machine_id=#{machineId}
    </select>
    
</mapper> 