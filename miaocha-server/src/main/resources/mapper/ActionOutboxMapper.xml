<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hinadt.miaocha.infrastructure.mapper.ActionOutboxMapper">

    <resultMap id="ActionOutboxMap" type="com.hinadt.miaocha.domain.entity.ActionOutbox">
        <id     property="id"              column="id"/>
        <result property="actionId"        column="action_id"/>
        <result property="channelKey"      column="channel_key"/>
        <result property="conversationId"  column="conversation_id"/>
        <result property="actionType"      column="action_type"/>
        <result property="toolName"        column="tool_name"/>
        <result property="payloadJson"     column="payload_json"/>
        <result property="sequence"        column="sequence"/>
        <result property="targetNodeId"    column="target_node_id"/>
        <result property="status"          column="status"/>
        <result property="errorMessage"    column="error_message"/>
        <result property="createdAt"       column="created_at"/>
        <result property="sentAt"          column="sent_at"/>
        <result property="ackAt"           column="ack_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.hinadt.miaocha.domain.entity.ActionOutbox">
        INSERT INTO action_outbox
        (action_id, channel_key, conversation_id, action_type, tool_name, payload_json, sequence, target_node_id, status, error_message, created_at)
        VALUES
            (#{actionId}, #{channelKey}, #{conversationId}, #{actionType}, #{toolName}, #{payloadJson}, #{sequence}, #{targetNodeId}, #{status}, #{errorMessage}, NOW(3))
    </insert>

    <select id="selectPendingByNode" resultMap="ActionOutboxMap">
        SELECT *
        FROM action_outbox
        WHERE target_node_id = #{nodeId}
          AND status = '${@com.hinadt.miaocha.domain.enums.AIActionStatus@PENDING}'
        ORDER BY created_at
        LIMIT #{limit}
        FOR UPDATE
    </select>

    <update id="updateStatusSent">
        UPDATE action_outbox
        SET status = '${@com.hinadt.miaocha.domain.enums.AIActionStatus@SENT}',
            sent_at = #{sentAt}
        WHERE action_id = #{actionId}
          AND status = '${@com.hinadt.miaocha.domain.enums.AIActionStatus@PENDING}'
    </update>

    <update id="updateStatusDropped">
        UPDATE action_outbox
        SET status = '${@com.hinadt.miaocha.domain.enums.AIActionStatus@DROPPED}',
            error_message = #{errorMessage}
        WHERE action_id = #{actionId}
          AND status IN (
                         '${@com.hinadt.miaocha.domain.enums.AIActionStatus@PENDING}',
                         '${@com.hinadt.miaocha.domain.enums.AIActionStatus@SENT}'
            )
    </update>

    <update id="updateStatusAck">
        UPDATE action_outbox
        SET status = '${@com.hinadt.miaocha.domain.enums.AIActionStatus@ACK}',
            ack_at = #{ackAt}
        WHERE action_id = #{actionId}
          AND status = '${@com.hinadt.miaocha.domain.enums.AIActionStatus@SENT}'
    </update>

</mapper>
