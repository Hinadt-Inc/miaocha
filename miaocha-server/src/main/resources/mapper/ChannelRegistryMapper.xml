<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hinadt.miaocha.infrastructure.mapper.ChannelRegistryMapper">

    <resultMap id="ChannelRegistryMap" type="com.hinadt.miaocha.domain.entity.ChannelRegistry">
        <id     property="id"           column="id"/>
        <result property="channelKey"   column="channel_key"/>
        <result property="userId"       column="user_id"/>
        <result property="clientId"     column="client_id"/>
        <result property="pageId"       column="page_id"/>
        <result property="conversationId" column="conversation_id"/>
        <result property="nodeId"       column="node_id"/>
        <result property="wsConnId"     column="ws_conn_id"/>
        <result property="status"       column="status"/>
        <result property="lastSeenAt"   column="last_seen_at"/>
        <result property="createdAt"    column="created_at"/>
    </resultMap>

    <select id="selectByChannelKey" resultMap="ChannelRegistryMap">
        SELECT * FROM channel_registry WHERE channel_key = #{channelKey}
    </select>

    <insert id="insertOrUpdate" parameterType="com.hinadt.miaocha.domain.entity.ChannelRegistry">
        INSERT INTO channel_registry
        (channel_key, user_id, client_id, page_id, conversation_id, node_id, ws_conn_id, status, last_seen_at, created_at)
        VALUES
            (#{channelKey}, #{userId}, #{clientId}, #{pageId}, #{conversationId}, #{nodeId}, #{wsConnId}, #{status}, #{lastSeenAt}, NOW(3))
        ON DUPLICATE KEY UPDATE
                             user_id = VALUES(user_id),
                             tenant_id = VALUES(tenant_id),
                             client_id = VALUES(client_id),
                             page_id = VALUES(page_id),
                             conversation_id = VALUES(conversation_id),
                             node_id = VALUES(node_id),
                             ws_conn_id = VALUES(ws_connId),
                             status = VALUES(status),
                             last_seen_at = VALUES(lastSeenAt)
    </insert>

    <update id="updateStatusOffline">
        UPDATE channel_registry
        SET status = '${@com.hinadt.miaocha.domain.enums.WebSocketChannelStatus@OFFLINE}',
            last_seen_at = NOW(3)
        WHERE channel_key = #{channelKey}
    </update>

    <update id="updateStatusOnline">
        UPDATE channel_registry
        SET status = '${@com.hinadt.miaocha.domain.enums.WebSocketChannelStatus@ONLINE}',
            node_id = #{nodeId},
            ws_conn_id = #{wsConnId},
            last_seen_at = NOW(3)
        WHERE channel_key = #{channelKey}
    </update>

    <update id="updateLastSeenAt">
        UPDATE channel_registry
        SET last_seen_at = NOW(3)
        WHERE channel_key = #{channelKey}
    </update>

</mapper>
