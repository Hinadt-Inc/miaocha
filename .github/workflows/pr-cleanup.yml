name: PR CD Cleanup

on:
  pull_request:
    types: [ closed ]
    branches: [ dev ]

jobs:
  cleanup-k8s:
    runs-on: arc-runner-set
    if: ${{ contains(github.event.pull_request.labels.*.name, 'deploy to inner test k8s env') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Setup kubectl
        run: |
          echo "ðŸ”§ é…ç½® kubectl..."
          # åˆ›å»º kubeconfig æ–‡ä»¶
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config

          # éªŒè¯è¿žæŽ¥
          kubectl cluster-info

      - name: Cleanup Kubernetes resources
        run: |
          echo "ðŸ§¹ å¼€å§‹æ¸…ç† PR-${{ github.event.pull_request.number }} çš„ Kubernetes èµ„æº..."

          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export PR_NUMBER=${{ github.event.pull_request.number }}

          # æ‰§è¡Œæ¸…ç†
          chmod +x scripts/github/k8s/cleanup.sh
          ./scripts/github/k8s/cleanup.sh

      - name: Cleanup Docker images (optional)
        continue-on-error: true
        run: |
          echo "ðŸ³ æ¸…ç† Docker é•œåƒ..."

          # èŽ·å–é•œåƒåˆ—è¡¨
          IMAGES_TO_DELETE=$(docker images --format "table {{.Repository}}:{{.Tag}}" | grep "miaocha-test-pr" | grep "pr${{ github.event.pull_request.number }}" || true)

          if [ -n "$IMAGES_TO_DELETE" ]; then
            echo "å‘çŽ°ä»¥ä¸‹é•œåƒéœ€è¦åˆ é™¤:"
            echo "$IMAGES_TO_DELETE"

            # åˆ é™¤æœ¬åœ°é•œåƒ
            echo "$IMAGES_TO_DELETE" | xargs -r docker rmi -f
            echo "âœ… æœ¬åœ°é•œåƒæ¸…ç†å®Œæˆ"
          else
            echo "æœªæ‰¾åˆ°éœ€è¦æ¸…ç†çš„é•œåƒ"
          fi

      - name: Comment on PR with cleanup info
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.issue.number;
            const pr_state = context.payload.pull_request.state;
            const pr_merged = context.payload.pull_request.merged;

            let status_text = '';
            let status_icon = '';

            if (pr_merged) {
              status_text = 'å·²åˆå¹¶';
              status_icon = 'âœ…';
            } else if (pr_state === 'closed') {
              status_text = 'å·²å…³é—­';
              status_icon = 'âŒ';
            } else {
              status_text = 'çŠ¶æ€å˜æ›´';
              status_icon = 'ðŸ”„';
            }

            const comment = `## ðŸ§¹ å†…éƒ¨æµ‹è¯•çŽ¯å¢ƒå·²æ¸…ç†

            ${status_icon} **PR #${pr_number}** ${status_text}ï¼Œå†…éƒ¨æµ‹è¯•çŽ¯å¢ƒå·²è‡ªåŠ¨æ¸…ç†

            ### ðŸ“‹ æ¸…ç†å†…å®¹

            - âœ… Kubernetes namespace: \`miaocha-pr-${pr_number}\`
            - âœ… æ‰€æœ‰ Pod, Service, Deployment
            - âœ… æœ¬åœ° Docker é•œåƒ
            - âœ… ç›¸å…³ç½‘ç»œèµ„æº

            ### ðŸ“Š æ¸…ç†è¯¦æƒ…

            - **æ¸…ç†æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
            - **æ¸…ç†åŽŸå› **: PR ${status_text}
            - **èµ„æºçŠ¶æ€**: å·²å®Œå…¨æ¸…ç†

            ### ðŸŽ‰ æ¸…ç†å®Œæˆ

            æ‰€æœ‰ä¸Žæ­¤ PR ç›¸å…³çš„å†…éƒ¨æµ‹è¯•çŽ¯å¢ƒèµ„æºå·²å®Œå…¨æ¸…ç†ï¼Œä¸ä¼šäº§ç”Ÿé¢å¤–è´¹ç”¨ã€‚

            ---
            *ðŸ¤– æ­¤è¯„è®ºç”± CI/CD è‡ªåŠ¨ç”Ÿæˆ*`;

            // åˆ›å»ºæ¸…ç†è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: comment
            });

            console.log('âœ… åˆ›å»ºäº†æ¸…ç†å®Œæˆè¯„è®º');

      - name: Summary
        run: |
          echo "## ðŸ§¹ PR æ¸…ç†å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æ¸…ç†å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kubernetes namespace: miaocha-pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ‰€æœ‰ç›¸å…³çš„ Pod, Service, Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æœ¬åœ° Docker é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ‰ èµ„æºå·²å®Œå…¨æ¸…ç†" >> $GITHUB_STEP_SUMMARY
          echo "PR-${{ github.event.pull_request.number }} çš„æ‰€æœ‰æµ‹è¯•çŽ¯å¢ƒèµ„æºå·²æ¸…ç†å®Œæ¯•" >> $GITHUB_STEP_SUMMARY
