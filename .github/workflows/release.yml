name: Release Automation

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    # å£°æ˜å¿…è¦çš„æƒé™
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is from release branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "æ£€æŸ¥ tag: $TAG_NAME"

          # è·å– tag æŒ‡å‘çš„ commit
          TAG_COMMIT=$(git rev-list -n 1 $TAG_NAME)

          # æ£€æŸ¥åŒ…å«æ­¤ commit çš„ release-* åˆ†æ”¯
          RELEASE_BRANCHES=$(git branch -r --contains $TAG_COMMIT | grep -E "origin/release-" | head -1)

          if [ -z "$RELEASE_BRANCHES" ]; then
            echo "âŒ Error: Tag '$TAG_NAME' ä¸æ˜¯ä» release-* åˆ†æ”¯æ¨é€çš„"
            echo "åŒ…å«æ­¤ commit çš„åˆ†æ”¯:"
            git branch -r --contains $TAG_COMMIT
            exit 1
          fi

          echo "âœ… Tag '$TAG_NAME' æ¥è‡ªæœ‰æ•ˆçš„ release åˆ†æ”¯: $RELEASE_BRANCHES"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Configure system for Doris
        run: |
          # å…³é—­swapåˆ†åŒº
          sudo swapoff -a

          # è®¾ç½®ç³»ç»Ÿå‚æ•°
          sudo sysctl -w vm.max_map_count=2000000
          sudo sysctl -w vm.swappiness=0
          sudo sysctl -w fs.file-max=655360

          # éªŒè¯è®¾ç½®
          echo "=== System Configuration ==="
          echo "Swap status:"
          swapon --show
          echo "vm.max_map_count: $(cat /proc/sys/vm/max_map_count)"
          echo "vm.swappiness: $(cat /proc/sys/vm/swappiness)"
          echo "fs.file-max: $(cat /proc/sys/fs/file-max)"

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          # ä½¿ç”¨è„šæœ¬ç”ŸæˆRelease Notesï¼Œé¿å…é‡å¤ä»£ç 
          release_notes=$(./scripts/release-version.sh --generate-release-notes-only ${{ steps.version.outputs.VERSION }})

          # æ‰“å°Release Notesåˆ°æ—¥å¿—ä¸­ä¾›æŸ¥çœ‹
          echo "## ğŸ“‹ ç”Ÿæˆçš„ Release Notes:"
          echo "========================================"
          echo "$release_notes"
          echo "========================================"

          # è¾“å‡ºåˆ°GitHub Actions
          {
            echo 'RELEASE_NOTES<<EOF'
            echo "$release_notes"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Build and package distribution
        run: mvn clean verify

      - name: Get lowercase repository name
        id: repo
        run: echo "REPOSITORY=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.REPOSITORY }}:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.repo.outputs.REPOSITORY }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            dist/miaocha-*-bin.zip
            dist/miaocha-*-bin.tar.gz
            dist/miaocha-*-source.zip
            dist/miaocha-*-source.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ğŸ‰ å‘å¸ƒæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockeré•œåƒ**: ghcr.io/${{ steps.repo.outputs.REPOSITORY }}:${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†å‘åŒ…**: miaocha-${{ steps.version.outputs.VERSION }}-bin.zip/tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **æºç åŒ…**: miaocha-${{ steps.version.outputs.VERSION }}-source.zip/tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **Releaseé¡µé¢**: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
