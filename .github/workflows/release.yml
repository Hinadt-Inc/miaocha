name: Release Automation

on:
  # æ‰‹åŠ¨è§¦å‘å‘ç‰ˆ
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (å¦‚: 2.1.0)'
        required: true
        type: string
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: false
        type: choice
        default: 'manual'
        options:
          - manual
          - patch
          - minor
          - major
      pre_release:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯• (ä»…ç”¨äºç´§æ€¥å‘ç‰ˆ)'
        required: false
        type: boolean
        default: false

  # å½“åˆ›å»ºv*æ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ç‰ˆæœ¬éªŒè¯å’Œå‡†å¤‡
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      should_build: ${{ steps.changes.outputs.should_build }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.version_type }}" != "manual" ]; then
              # è‡ªåŠ¨è®¡ç®—ç‰ˆæœ¬
              current_version=$(grep -m 1 '<version>' pom.xml | sed 's/.*<version>\(.*\)<\/version>.*/\1/' | tr -d ' \t\n' | sed 's/-SNAPSHOT//')
              major=$(echo "$current_version" | cut -d. -f1)
              minor=$(echo "$current_version" | cut -d. -f2)
              patch=$(echo "$current_version" | cut -d. -f3)
              
              case "${{ inputs.version_type }}" in
                "patch")
                  version="$major.$minor.$((patch + 1))"
                  ;;
                "minor")
                  version="$major.$((minor + 1)).0"
                  ;;
                "major")
                  version="$((major + 1)).0.0"
                  ;;
              esac
            else
              version="${{ inputs.version }}"
            fi
            is_prerelease="${{ inputs.pre_release }}"
          else
            # ä»æ ‡ç­¾è·å–ç‰ˆæœ¬
            version="${GITHUB_REF#refs/tags/v}"
            # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
            if [[ "$version" =~ -[a-zA-Z] ]]; then
              is_prerelease="true"
            else
              is_prerelease="false"
            fi
          fi
          
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT
          echo "ğŸš€ å‘å¸ƒç‰ˆæœ¬: $version"
          echo "ğŸ“¦ é¢„å‘å¸ƒ: $is_prerelease"

      - name: Check for significant changes
        id: changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§å˜æ›´ï¼ˆæ’é™¤æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶ï¼‰
          if git tag --list | grep -q "v"; then
            last_tag=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
            if [ -n "$last_tag" ]; then
              changes=$(git diff --name-only "$last_tag..HEAD" | grep -v -E '(README|\.md$|\.yml$|\.yaml$|\.json$|docs/|\.github/)' || true)
              if [ -n "$changes" ]; then
                echo "should_build=true" >> $GITHUB_OUTPUT
                echo "âœ… æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œå°†æ„å»ºå‘å¸ƒèµ„äº§"
              else
                echo "should_build=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ ä»…æ–‡æ¡£å˜æ›´ï¼Œè·³è¿‡æ„å»º"
              fi
            else
              echo "should_build=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure system for Doris
        run: |
          sudo swapoff -a
          sudo sysctl -w vm.max_map_count=2000000
          sudo sysctl -w vm.swappiness=0
          sudo sysctl -w fs.file-max=655360

      - name: Update version in POM
        run: |
          mvn versions:set -DnewVersion="${{ needs.prepare.outputs.version }}" -DgenerateBackupPoms=false

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶"
          mvn clean verify

      - name: Build without tests
        if: ${{ inputs.skip_tests }}
        run: |
          echo "âš ï¸ è·³è¿‡æµ‹è¯•çš„ç´§æ€¥æ„å»º"
          mvn clean package -DskipTests

      - name: Build distribution
        run: |
          echo "ğŸ“¦ æ„å»ºå‘å¸ƒåˆ†å‘åŒ…"
          mvn clean verify -DskipTests
          
          # åˆ—å‡ºæ„å»ºäº§ç‰©
          echo "=== æ„å»ºäº§ç‰© ==="
          find dist -type f -name "*.zip" -o -name "*.tar.gz" | head -10

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.prepare.outputs.version }}
          path: |
            dist/miaocha-*-bin.zip
            dist/miaocha-*-bin.tar.gz
            dist/miaocha-*-src.zip
          retention-days: 30

  # æ„å»ºå’Œæ¨é€Dockeré•œåƒ
  build-docker:
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test]
    if: needs.prepare.outputs.should_build == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Update version in POM
        run: |
          mvn versions:set -DnewVersion="${{ needs.prepare.outputs.version }}" -DgenerateBackupPoms=false

      - name: Build application
        run: |
          mvn clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=raw,value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ç”ŸæˆRelease Notes
  generate-release-notes:
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      release_notes: ${{ steps.notes.outputs.release_notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate RocketMQ-style release notes
        id: notes
        run: |
          version="${{ needs.prepare.outputs.version }}"
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          last_tag=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          # ç”ŸæˆRocketMQé£æ ¼çš„release notes
          cat > release_notes.md << 'EOF'
          ## What's Changed
          
          This version includes several improvements and bug fixes based on community feedback.
          
          EOF
          
          if [ -n "$last_tag" ]; then
            # ç»Ÿè®¡ä¿¡æ¯
            total_commits=$(git rev-list --count "$last_tag..HEAD" 2>/dev/null || echo "0")
            issue_count=$(git log --oneline "$last_tag..HEAD" | grep -c "\[ISSUE" || echo "0")
            echo "**Stats**: $total_commits commits, $issue_count issues addressed" >> release_notes.md
            echo "" >> release_notes.md
            
            # è·å–merge commits (é€šå¸¸åŒ…å«[ISSUE #xx]æ ¼å¼) - è¿™æ˜¯é‡ç‚¹ï¼
            merge_commits=$(git log --merges --oneline --pretty=format:"* %s" "$last_tag..HEAD" | grep -E "\[ISSUE.*\]" || echo "")
            all_issue_commits=$(git log --oneline --pretty=format:"* %s" "$last_tag..HEAD" | grep -E "\[ISSUE.*\]" || echo "")
            
            # ä¼˜å…ˆä½¿ç”¨merge commitsï¼ˆè¿™äº›é€šå¸¸æ˜¯PRåˆå¹¶åˆ°devåˆ†æ”¯çš„è®°å½•ï¼‰
            issue_commits=""
            if [ -n "$merge_commits" ]; then
              issue_commits="$merge_commits"
              echo "<!-- åŸºäºmerge commits (PRåˆå¹¶è®°å½•) ç”Ÿæˆ -->" >> release_notes.md
            else
              issue_commits="$all_issue_commits"  
              echo "<!-- åŸºäº[ISSUE #xx]æäº¤ç”Ÿæˆ -->" >> release_notes.md
            fi
            
            if [ -n "$issue_commits" ]; then
              # æ–°åŠŸèƒ½å’Œä¼˜åŒ– - åŸºäºmerge commits
              features=$(echo "$issue_commits" | grep -E "\[ISSUE.*\].*(æ–°å¢|feat|feature|å®Œå–„|ä¼˜åŒ–|enhancement|æ”¯æŒ)" || echo "")
              if [ -n "$features" ]; then
                echo "### ğŸš€ New Features & Enhancements" >> release_notes.md
                echo "$features" >> release_notes.md
                echo "" >> release_notes.md
              fi
              
              # é”™è¯¯ä¿®å¤ - åŸºäºmerge commits
              bugfixes=$(echo "$issue_commits" | grep -E "\[ISSUE.*\].*(ä¿®å¤|fix|bug|è§£å†³)" || echo "")
              if [ -n "$bugfixes" ]; then
                echo "### ğŸ› Bug Fixes" >> release_notes.md
                echo "$bugfixes" >> release_notes.md
                echo "" >> release_notes.md
              fi
              
              # æ–‡æ¡£ç­‰å…¶ä»–å˜æ›´ - åŸºäºmerge commits
              docs=$(echo "$issue_commits" | grep -E "\[ISSUE.*\].*(æ–‡æ¡£|doc|è¡¥å……|æ›´æ–°|chore)" || echo "")
              if [ -n "$docs" ]; then
                echo "### ğŸ“š Documentation & Others" >> release_notes.md
                echo "$docs" >> release_notes.md
                echo "" >> release_notes.md
              fi
            fi
            
            # æ‰€æœ‰[ISSUE #xx]æ ¼å¼çš„å˜æ›´
            all_issues=$(git log --oneline --pretty=format:"* %s" "$last_tag..HEAD" | grep -E "\[ISSUE.*\]" | head -50)
            if [ -n "$all_issues" ]; then
              echo "### ğŸ“ All Changes" >> release_notes.md
              echo "$all_issues" >> release_notes.md
              echo "" >> release_notes.md
            fi
            
            # æ–°è´¡çŒ®è€…
            echo "### ğŸ‘¥ New Contributors" >> release_notes.md
            contributors=$(git log --pretty=format:"%an" "$last_tag..HEAD" | sort | uniq)
            if [ -n "$contributors" ]; then
              echo "$contributors" | sed 's/^/* @/' >> release_notes.md
            else
              echo "* No new contributors in this release" >> release_notes.md
            fi
            echo "" >> release_notes.md
            
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$last_tag...v$version" >> release_notes.md
          else
            echo "### ğŸ‰ Initial Release" >> release_notes.md
            echo "" >> release_notes.md
            echo "* Initial release of ç§’æŸ¥ç³»ç»Ÿ (MiaoCha System)" >> release_notes.md
            echo "* Core functionality implementation completed" >> release_notes.md
            echo "" >> release_notes.md
            echo "### ğŸ‘¥ Contributors" >> release_notes.md
            git log --pretty=format:"%an" | sort | uniq | sed 's/^/* @/' >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          
          ### ğŸ“¦ å®‰è£…æ–¹å¼
          
          #### Docker
          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$version
          \`\`\`
          
          #### æºç ç¼–è¯‘
          \`\`\`bash
          git clone https://github.com/${{ github.repository }}.git
          cd miaocha
          git checkout v$version
          mvn clean package
          \`\`\`
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - ğŸ“– [æ–‡æ¡£](https://github.com/${{ github.repository }}/tree/v$version/docs)
          - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          - ğŸ’¬ [è®¨è®ºåŒº](https://github.com/${{ github.repository }}/discussions)
          
          ---
          **å®Œæ•´æ›´æ”¹æ—¥å¿—**: [\`$last_tag...v$version\`](https://github.com/${{ github.repository }}/compare/$last_tag...v$version)
          EOF
          
          # è¾“å‡ºåˆ°GitHub Actions
          {
            echo 'release_notes<<EOF'
            cat release_notes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ needs.prepare.outputs.version }}
          path: release_notes.md

  # åˆ›å»ºGitHub Release
  create-release:
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test, build-docker, generate-release-notes]
    if: always() && (needs.build-and-test.result == 'success' || needs.build-and-test.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        if: needs.prepare.outputs.should_build == 'true'
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.prepare.outputs.version }}
          path: ./release-assets

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          release_name: ğŸš€ ç§’æŸ¥ç³»ç»Ÿ v${{ needs.prepare.outputs.version }}
          body: ${{ needs.generate-release-notes.outputs.release_notes }}
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease }}

      - name: Upload Release Assets
        if: needs.prepare.outputs.should_build == 'true'
        run: |
          for file in release-assets/*; do
            if [ -f "$file" ]; then
              echo "ä¸Šä¼ èµ„äº§: $(basename "$file")"
              gh release upload "v${{ needs.prepare.outputs.version }}" "$file" --clobber
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåé€šçŸ¥
  post-release:
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: always() && needs.create-release.result == 'success'
    steps:
      - name: Post-release summary
        run: |
          echo "## ğŸ‰ å‘å¸ƒæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: v${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç±»å‹**: ${{ needs.prepare.outputs.is_prerelease == 'true' && 'é¢„å‘å¸ƒ' || 'æ­£å¼å‘å¸ƒ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“‹ Releaseé¡µé¢](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ³ Dockeré•œåƒ](${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.prepare.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“¦ ä¸‹è½½é¡µé¢](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY

      # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ°å…¶ä»–å¹³å°ï¼ˆå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰ï¼‰
      # - name: Send notification
      #   run: |
      #     curl -X POST "https://your-webhook-url" \
      #       -H "Content-Type: application/json" \
      #       -d '{
      #         "msg_type": "text",
      #         "content": {
      #           "text": "ğŸš€ ç§’æŸ¥ç³»ç»Ÿ v${{ needs.prepare.outputs.version }} å·²å‘å¸ƒï¼"
      #         }
      #       }' 