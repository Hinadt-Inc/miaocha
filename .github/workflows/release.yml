name: Release Automation

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    # Declare required permissions
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is from release branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Checking tag: $TAG_NAME"

          # Get commit that the tag points to
          TAG_COMMIT=$(git rev-list -n 1 $TAG_NAME)

          # Check release-* branches containing this commit
          RELEASE_BRANCHES=$(git branch -r --contains $TAG_COMMIT | grep -E "origin/release-" | head -1)

          if [ -z "$RELEASE_BRANCHES" ]; then
            echo "‚ùå Error: Tag '$TAG_NAME' is not pushed from a release-* branch"
            echo "Branches containing this commit:"
            git branch -r --contains $TAG_COMMIT
            exit 1
          fi

          echo "‚úÖ Tag '$TAG_NAME' is from a valid release branch: $RELEASE_BRANCHES"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

      - name: Configure system for Doris
        run: |
          # Disable swap
          sudo swapoff -a

          # Tune kernel parameters
          sudo sysctl -w vm.max_map_count=2000000
          sudo sysctl -w vm.swappiness=0
          sudo sysctl -w fs.file-max=655360

          # Verify settings
          echo "=== System Configuration ==="
          echo "Swap status:"
          swapon --show
          echo "vm.max_map_count: $(cat /proc/sys/vm/max_map_count)"
          echo "vm.swappiness: $(cat /proc/sys/vm/swappiness)"
          echo "fs.file-max: $(cat /proc/sys/fs/file-max)"

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Get Release Notes
        id: release_notes
        run: |
          # Check whether RELEASE_NOTES.md exists
          if [ ! -f "RELEASE_NOTES.md" ]; then
            echo "‚ùå Error: RELEASE_NOTES.md not found"
            echo "Please run release-version.sh to generate Release Notes before releasing"
            exit 1
          fi
          
          echo "## üìã Using existing Release Notes file:"
          echo "========================================"
          cat RELEASE_NOTES.md
          echo "========================================"
          
          # ËæìÂá∫Âà∞GitHub Actions
          {
            echo 'RELEASE_NOTES<<EOF'
            cat RELEASE_NOTES.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Build and package distribution
        run: mvn clean verify

      - name: Get lowercase repository name
        id: repo
        run: echo "REPOSITORY=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.REPOSITORY }}:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.repo.outputs.REPOSITORY }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: |
            dist/miaocha-*-bin.zip
            dist/miaocha-*-bin.tar.gz
            dist/miaocha-*-source.zip
            dist/miaocha-*-source.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## üéâ Release successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker image**: ghcr.io/${{ steps.repo.outputs.REPOSITORY }}:${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Binary**: miaocha-${{ steps.version.outputs.VERSION }}-bin.zip/tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: miaocha-${{ steps.version.outputs.VERSION }}-source.zip/tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- **Release page**: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
