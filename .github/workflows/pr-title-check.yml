name: PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches: [ dev ]

jobs:
  check-pr-title:
    runs-on: ubuntu-latest
    permissions:
      issues: read  # éœ€è¦è¯»å–issuesçš„æƒé™
      pull-requests: write  # éœ€è¦å†™å…¥PRçš„æƒé™ï¼Œç”¨äºæ›´æ–°PRæè¿°
    steps:
      - name: Check PR title format
        id: check-title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # æ£€æŸ¥æ˜¯å¦ä»¥ [ISSUE #xxx] å¼€å¤´
          if [[ ! "$PR_TITLE" =~ ^\[ISSUE\ #[0-9]+\] ]]; then
            echo "âŒ PRæ ‡é¢˜æ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ '[ISSUE #xxx]' å¼€å¤´"
            echo "æ­£ç¡®æ ¼å¼ç¤ºä¾‹: [ISSUE #17] æ”¯æŒå…¨å±€ Trace æ—¥å¿—ID ç‰¹æ€§"
            exit 1
          fi
          
          # æå–issueç¼–å·
          ISSUE_NUMBER=$(echo "$PR_TITLE" | grep -o '#[0-9]*' | grep -o '[0-9]*')
          echo "Issue Number: $ISSUE_NUMBER"
          
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âŒ æ— æ³•ä»PRæ ‡é¢˜ä¸­æå–issueç¼–å·"
            exit 1
          fi
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PRæ ‡é¢˜æ ¼å¼æ­£ç¡®"

      - name: Check if issue exists and is open
        id: check-issue
        run: |
          ISSUE_NUMBER="${{ steps.check-title.outputs.issue_number }}"
          
          # ä½¿ç”¨GitHub APIæ£€æŸ¥issueçŠ¶æ€
          ISSUE_RESPONSE=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
          
          echo "Issue API Response: $ISSUE_RESPONSE"
          
          # æ£€æŸ¥issueæ˜¯å¦å­˜åœ¨
          if echo "$ISSUE_RESPONSE" | grep -q '"message":"Not Found"'; then
            echo "âŒ Issue #$ISSUE_NUMBER ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ä½¿ç”¨jqè§£æJSONï¼Œæå–issueçŠ¶æ€
          ISSUE_STATE=$(echo "$ISSUE_RESPONSE" | jq -r '.state')
          echo "Issue State: $ISSUE_STATE"
          
          if [ "$ISSUE_STATE" != "open" ]; then
            echo "âŒ Issue #$ISSUE_NUMBER çŠ¶æ€ä¸æ˜¯open (å½“å‰çŠ¶æ€: $ISSUE_STATE)"
            exit 1
          fi
          
          # ä½¿ç”¨jqè§£æJSONï¼Œæå–issueæ ‡é¢˜
          ISSUE_TITLE=$(echo "$ISSUE_RESPONSE" | jq -r '.title')
          echo "Issue Title: $ISSUE_TITLE"
          
          echo "âœ… Issue #$ISSUE_NUMBER å­˜åœ¨ä¸”çŠ¶æ€ä¸ºopen"
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

      - name: Check if PR is already linked to Issue
        id: check-link
        env:
          CURRENT_BODY: ${{ github.event.pull_request.body }}
        run: |
          ISSUE_NUMBER="${{ steps.check-title.outputs.issue_number }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "ğŸ” æ£€æŸ¥PRæ˜¯å¦å·²ç»å…³è”åˆ°Issue #$ISSUE_NUMBER"
          echo "å½“å‰PRæè¿°: (å†…å®¹å·²å®‰å…¨å¤„ç†)"
          
          # åˆå§‹åŒ–å…³è”çŠ¶æ€
          IS_LINKED=false
          LINK_REASON=""
          
          # æ–¹æ³•1ï¼šæ£€æŸ¥PRæè¿°ä¸­æ˜¯å¦åŒ…å«å…³è”å…³é”®è¯
          if printf '%s' "$CURRENT_BODY" | grep -qEi "(close[sd]?|fix(e[sd])?|resolve[sd]?) #$ISSUE_NUMBER\b"; then
            IS_LINKED=true
            LINK_REASON="PRæè¿°ä¸­åŒ…å«å…³è”å…³é”®è¯"
            echo "âœ… æ£€æµ‹åˆ°å…³è”ï¼š$LINK_REASON"
          fi
          
          # æ–¹æ³•2ï¼šæ£€æŸ¥PRçš„æ—¶é—´çº¿äº‹ä»¶ï¼Œçœ‹æ˜¯å¦æœ‰connectedäº‹ä»¶
          if [ "$IS_LINKED" = false ]; then
            echo "ğŸ” æ£€æŸ¥PRæ—¶é—´çº¿äº‹ä»¶..."
            TIMELINE_RESPONSE=$(curl -s -H "Authorization: token ${{ github.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/timeline")
            
            if echo "$TIMELINE_RESPONSE" | jq -e ".[] | select(.event == \"connected_event\" and .source.issue.number == $ISSUE_NUMBER)" > /dev/null 2>&1; then
              IS_LINKED=true
              LINK_REASON="æ£€æµ‹åˆ°GitHubè¿æ¥äº‹ä»¶"
              echo "âœ… æ£€æµ‹åˆ°å…³è”ï¼š$LINK_REASON"
            fi
          fi
          
          # æ–¹æ³•3ï¼šæ£€æŸ¥Issueçš„æ—¶é—´çº¿ï¼Œçœ‹æ˜¯å¦è¢«è¿™ä¸ªPRå…³è”
          if [ "$IS_LINKED" = false ]; then
            echo "ğŸ” æ£€æŸ¥Issueæ—¶é—´çº¿äº‹ä»¶..."
            ISSUE_TIMELINE=$(curl -s -H "Authorization: token ${{ github.token }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/timeline")
            
            if echo "$ISSUE_TIMELINE" | jq -e ".[] | select(.event == \"connected_event\" and .source.issue.number == $PR_NUMBER)" > /dev/null 2>&1; then
              IS_LINKED=true
              LINK_REASON="Issueæ—¶é—´çº¿æ˜¾ç¤ºå·²è¿æ¥"
              echo "âœ… æ£€æµ‹åˆ°å…³è”ï¼š$LINK_REASON"
            fi
          fi
          
          # æ–¹æ³•4ï¼šæ£€æŸ¥PRæè¿°ä¸­æ˜¯å¦æœ‰å…¶ä»–å¼•ç”¨æ ¼å¼
          if [ "$IS_LINKED" = false ]; then
            if printf '%s' "$CURRENT_BODY" | grep -qE "#$ISSUE_NUMBER\b"; then
              IS_LINKED=true
              LINK_REASON="PRæè¿°ä¸­å¼•ç”¨äº†Issue"
              echo "âœ… æ£€æµ‹åˆ°å…³è”ï¼š$LINK_REASON"
            fi
          fi
          
          echo "is_linked=$IS_LINKED" >> $GITHUB_OUTPUT
          echo "link_reason=$LINK_REASON" >> $GITHUB_OUTPUT
          
          if [ "$IS_LINKED" = true ]; then
            echo "âœ… PRå·²ç»å…³è”åˆ°Issue #$ISSUE_NUMBER ($LINK_REASON)"
          else
            echo "â„¹ï¸ PRå°šæœªå…³è”åˆ°Issue #$ISSUE_NUMBERï¼Œå°†è‡ªåŠ¨æ·»åŠ å…³è”"
          fi

      - name: Auto link PR to Issue
        id: link-issue
        if: ${{ steps.check-link.outputs.is_linked == 'false' }}
        env:
          CURRENT_BODY: ${{ github.event.pull_request.body }}
        run: |
          ISSUE_NUMBER="${{ steps.check-title.outputs.issue_number }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "ğŸ”— å¼€å§‹è‡ªåŠ¨å…³è”PR #$PR_NUMBER åˆ°Issue #$ISSUE_NUMBER"
          
          # æ„å»ºå…³è”æ–‡æœ¬
          LINK_TEXT="Closes #$ISSUE_NUMBER"
          
          # æ„å»ºæ–°çš„PRæè¿°
          if [ -z "$CURRENT_BODY" ] || [ "$CURRENT_BODY" == "null" ]; then
            NEW_BODY="$LINK_TEXT"
          else
            NEW_BODY="$LINK_TEXT"$'\n\n'"$CURRENT_BODY"
          fi
          
          echo "æ–°çš„PRæè¿°: (å†…å®¹å·²å®‰å…¨å¤„ç†)"
          
          # ä½¿ç”¨GitHub APIæ›´æ–°PRæè¿°
          UPDATE_RESPONSE=$(curl -s -w "%{http_code}" -X PATCH \
            -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" \
            -d "$(jq -n --arg body "$NEW_BODY" '{body: $body}')")
          
          HTTP_CODE="${UPDATE_RESPONSE: -3}"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… æˆåŠŸå…³è”PR #$PR_NUMBER åˆ°Issue #$ISSUE_NUMBER"
            echo "link_added=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ å…³è”å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $HTTP_CODE"
            echo "å“åº”: ${UPDATE_RESPONSE%???}"
            echo "link_added=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Success message
        run: |
          ISSUE_NUMBER="${{ steps.check-title.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.check-issue.outputs.issue_title }}"
          IS_LINKED="${{ steps.check-link.outputs.is_linked }}"
          LINK_REASON="${{ steps.check-link.outputs.link_reason }}"
          LINK_ADDED="${{ steps.link-issue.outputs.link_added }}"
          
          echo "ğŸ‰ PRæ ‡é¢˜æ ¡éªŒé€šè¿‡ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ PRæ ‡é¢˜: ${{ github.event.pull_request.title }}"
          echo "ğŸ”— å…³è”Issue: #$ISSUE_NUMBER"
          echo "ğŸ“ Issueæ ‡é¢˜: $ISSUE_TITLE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$IS_LINKED" = "true" ]; then
            echo "âœ… å…³è”çŠ¶æ€: å·²å…³è” ($LINK_REASON)"
            echo "ğŸ’¡ æ— éœ€é‡å¤æ“ä½œï¼ŒPRå·²æ­£ç¡®å…³è”åˆ°Issue"
          elif [ "$LINK_ADDED" = "true" ]; then
            echo "âœ… å…³è”çŠ¶æ€: å·²è‡ªåŠ¨æ·»åŠ å…³è”"
            echo "ğŸ“ PRå·²è‡ªåŠ¨å…³è”åˆ°Issueï¼Œåˆå¹¶PRæ—¶å°†è‡ªåŠ¨å…³é—­å¯¹åº”çš„Issue"
          else
            echo "âš ï¸ å…³è”çŠ¶æ€: å…³è”å¤±è´¥"
          fi 