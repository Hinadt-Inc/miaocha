name: PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches: [ dev ]

jobs:
  check-pr-title:
    runs-on: ubuntu-latest
    permissions:
      issues: read  # éœ€è¦è¯»å–issuesçš„æƒé™
      pull-requests: read  # éœ€è¦è¯»å–PRçš„æƒé™
    steps:
      - name: Check PR title format
        id: check-title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # æ£€æŸ¥æ˜¯å¦ä»¥ [ISSUE #xxx] å¼€å¤´
          if [[ ! "$PR_TITLE" =~ ^\[ISSUE\ #[0-9]+\] ]]; then
            echo "âŒ PRæ ‡é¢˜æ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ '[ISSUE #xxx]' å¼€å¤´"
            echo "æ­£ç¡®æ ¼å¼ç¤ºä¾‹: [ISSUE #17] æ”¯æŒå…¨å±€ Trace æ—¥å¿—ID ç‰¹æ€§"
            exit 1
          fi
          
          # æå–issueç¼–å·
          ISSUE_NUMBER=$(echo "$PR_TITLE" | grep -o '#[0-9]*' | grep -o '[0-9]*')
          echo "Issue Number: $ISSUE_NUMBER"
          
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âŒ æ— æ³•ä»PRæ ‡é¢˜ä¸­æå–issueç¼–å·"
            exit 1
          fi
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ… PRæ ‡é¢˜æ ¼å¼æ­£ç¡®"

      - name: Check if issue exists and is open
        id: check-issue
        run: |
          ISSUE_NUMBER="${{ steps.check-title.outputs.issue_number }}"
          
          # ä½¿ç”¨GitHub APIæ£€æŸ¥issueçŠ¶æ€
          ISSUE_RESPONSE=$(curl -s -H "Authorization: token ${{ github.token }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
          
          echo "Issue API Response: $ISSUE_RESPONSE"
          
          # æ£€æŸ¥issueæ˜¯å¦å­˜åœ¨
          if echo "$ISSUE_RESPONSE" | grep -q '"message":"Not Found"'; then
            echo "âŒ Issue #$ISSUE_NUMBER ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ä½¿ç”¨jqè§£æJSONï¼Œæå–issueçŠ¶æ€
          ISSUE_STATE=$(echo "$ISSUE_RESPONSE" | jq -r '.state')
          echo "Issue State: $ISSUE_STATE"
          
          if [ "$ISSUE_STATE" != "open" ]; then
            echo "âŒ Issue #$ISSUE_NUMBER çŠ¶æ€ä¸æ˜¯open (å½“å‰çŠ¶æ€: $ISSUE_STATE)"
            exit 1
          fi
          
          # ä½¿ç”¨jqè§£æJSONï¼Œæå–issueæ ‡é¢˜
          ISSUE_TITLE=$(echo "$ISSUE_RESPONSE" | jq -r '.title')
          echo "Issue Title: $ISSUE_TITLE"
          
          echo "âœ… Issue #$ISSUE_NUMBER å­˜åœ¨ä¸”çŠ¶æ€ä¸ºopen"
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT

      - name: Success message
        run: |
          echo "ğŸ‰ PRæ ‡é¢˜æ ¡éªŒé€šè¿‡ï¼"
          echo "PRæ ‡é¢˜: ${{ github.event.pull_request.title }}"
          echo "å…³è”Issue: #${{ steps.check-title.outputs.issue_number }}"
          echo "Issueæ ‡é¢˜: ${{ steps.check-issue.outputs.issue_title }}" 