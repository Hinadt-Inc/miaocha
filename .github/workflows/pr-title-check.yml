name: PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches: [ dev ]

jobs:
  check-pr-title:
    runs-on: ubuntu-latest
    permissions:
      issues: read  # éœ€è¦è¯»å–issuesçš„æƒé™
      pull-requests: write  # éœ€è¦å†™å…¥PRçš„æƒé™ï¼Œç”¨äºæ›´æ–°PRæè¿°
    steps:
      - name: Check PR title format
        id: check-title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "PR Title: $PR_TITLE"
          
          # ä½¿ç”¨ Python è„šæœ¬è¿›è¡Œæ›´å®‰å…¨çš„å­—ç¬¦ä¸²å¤„ç†
          python3 << 'EOF'
          import os
          import re
          import sys
          
          # ä»ç¯å¢ƒå˜é‡è·å– PR æ ‡é¢˜ï¼Œé¿å… shell æ³¨å…¥
          pr_title = os.environ.get('PR_TITLE', '')
          print(f"Processing PR Title: {repr(pr_title)}")
          
          # æ£€æŸ¥æ ‡é¢˜æ ¼å¼ï¼šå¿…é¡»ä»¥ [ISSUE #æ•°å­—] å¼€å¤´
          pattern = r'^\[ISSUE #(\d+)\]'
          match = re.match(pattern, pr_title)
          
          if not match:
              print("âŒ PRæ ‡é¢˜æ ¼å¼é”™è¯¯ï¼å¿…é¡»ä»¥ '[ISSUE #xxx]' å¼€å¤´")
              print("æ­£ç¡®æ ¼å¼ç¤ºä¾‹: [ISSUE #17] æ”¯æŒå…¨å±€ Trace æ—¥å¿—ID ç‰¹æ€§")
              print(f"å½“å‰æ ‡é¢˜: {pr_title}")
              sys.exit(1)
          
          # æå– issue ç¼–å·
          issue_number = match.group(1)
          print(f"Issue Number: {issue_number}")
          
          # å°†ç»“æœå†™å…¥ GitHub Actions è¾“å‡º
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"issue_number={issue_number}\n")
          
          print("âœ… PRæ ‡é¢˜æ ¼å¼æ­£ç¡®")
          EOF

      - name: Check if issue exists and is open
        id: check-issue
        env:
          ISSUE_NUMBER: ${{ steps.check-title.outputs.issue_number }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "Checking Issue #$ISSUE_NUMBER"
          
          # ä½¿ç”¨ Python è¿›è¡Œ API è°ƒç”¨å’Œ JSON å¤„ç†
          python3 << 'EOF'
          import os
          import json
          import urllib.request
          import urllib.error
          import sys
          
          issue_number = os.environ['ISSUE_NUMBER']
          github_token = os.environ['GITHUB_TOKEN']
          github_repo = os.environ['GITHUB_REPOSITORY']
          
          # æ„å»º API URL
          api_url = f"https://api.github.com/repos/{github_repo}/issues/{issue_number}"
          
          # åˆ›å»ºè¯·æ±‚
          req = urllib.request.Request(api_url)
          req.add_header('Authorization', f'token {github_token}')
          req.add_header('Accept', 'application/vnd.github.v3+json')
          
          try:
              # å‘é€è¯·æ±‚
              with urllib.request.urlopen(req) as response:
                  issue_data = json.loads(response.read().decode())
              
              print(f"Issue #{issue_number} found")
              
              # æ£€æŸ¥ issue çŠ¶æ€
              state = issue_data.get('state', '')
              title = issue_data.get('title', '')
              
              print(f"Issue State: {state}")
              print(f"Issue Title: {title}")
              
              if state != 'open':
                  print(f"âŒ Issue #{issue_number} çŠ¶æ€ä¸æ˜¯open (å½“å‰çŠ¶æ€: {state})")
                  sys.exit(1)
              
              print(f"âœ… Issue #{issue_number} å­˜åœ¨ä¸”çŠ¶æ€ä¸ºopen")
              
              # å®‰å…¨åœ°å¤„ç†æ ‡é¢˜ä¸­çš„ç‰¹æ®Šå­—ç¬¦
              safe_title = title.replace('\n', '\\n').replace('\r', '\\r')
              
              # å†™å…¥è¾“å‡º
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"issue_title={safe_title}\n")
                  
          except urllib.error.HTTPError as e:
              if e.code == 404:
                  print(f"âŒ Issue #{issue_number} ä¸å­˜åœ¨")
              else:
                  print(f"âŒ API è¯·æ±‚å¤±è´¥: HTTP {e.code}")
              sys.exit(1)
          except Exception as e:
              print(f"âŒ å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
              sys.exit(1)
          EOF

      - name: Check if PR is already linked to Issue
        id: check-link
        env:
          CURRENT_BODY: ${{ github.event.pull_request.body }}
          ISSUE_NUMBER: ${{ steps.check-title.outputs.issue_number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ” æ£€æŸ¥PRæ˜¯å¦å·²ç»å…³è”åˆ°Issue #$ISSUE_NUMBER"
          
          # ä½¿ç”¨ Python è¿›è¡Œå®‰å…¨çš„å­—ç¬¦ä¸²å¤„ç†å’Œ API è°ƒç”¨
          python3 << 'EOF'
          import os
          import json
          import urllib.request
          import urllib.error
          import re
          import sys
          
          current_body = os.environ.get('CURRENT_BODY', '')
          issue_number = os.environ['ISSUE_NUMBER']
          pr_number = os.environ['PR_NUMBER']
          github_token = os.environ['GITHUB_TOKEN']
          github_repo = os.environ['GITHUB_REPOSITORY']
          
          print("å½“å‰PRæè¿°: (å†…å®¹å·²å®‰å…¨å¤„ç†)")
          
          # åˆå§‹åŒ–å…³è”çŠ¶æ€
          is_linked = False
          link_reason = ""
          
          # æ–¹æ³•1ï¼šæ£€æŸ¥PRæè¿°ä¸­æ˜¯å¦åŒ…å«å…³è”å…³é”®è¯
          if current_body:
              # åŒ¹é…å„ç§å…³è”å…³é”®è¯
              link_patterns = [
                  rf'\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#{issue_number}\b',
                  rf'#{issue_number}\b'
              ]
              
              for pattern in link_patterns:
                  if re.search(pattern, current_body, re.IGNORECASE):
                      is_linked = True
                      link_reason = "PRæè¿°ä¸­åŒ…å«å…³è”å…³é”®è¯"
                      print(f"âœ… æ£€æµ‹åˆ°å…³è”ï¼š{link_reason}")
                      break
          
          # æ–¹æ³•2ï¼šæ£€æŸ¥PRçš„æ—¶é—´çº¿äº‹ä»¶
          if not is_linked:
              print("ğŸ” æ£€æŸ¥PRæ—¶é—´çº¿äº‹ä»¶...")
              try:
                  timeline_url = f"https://api.github.com/repos/{github_repo}/issues/{pr_number}/timeline"
                  req = urllib.request.Request(timeline_url)
                  req.add_header('Authorization', f'token {github_token}')
                  req.add_header('Accept', 'application/vnd.github.v3+json')
                  
                  with urllib.request.urlopen(req) as response:
                      timeline_data = json.loads(response.read().decode())
                  
                  for event in timeline_data:
                      if (event.get('event') == 'connected_event' and 
                          event.get('source', {}).get('issue', {}).get('number') == int(issue_number)):
                          is_linked = True
                          link_reason = "æ£€æµ‹åˆ°GitHubè¿æ¥äº‹ä»¶"
                          print(f"âœ… æ£€æµ‹åˆ°å…³è”ï¼š{link_reason}")
                          break
              except Exception as e:
                  print(f"âš ï¸ æ£€æŸ¥PRæ—¶é—´çº¿æ—¶å‡ºé”™: {str(e)}")
          
          # æ–¹æ³•3ï¼šæ£€æŸ¥Issueçš„æ—¶é—´çº¿
          if not is_linked:
              print("ğŸ” æ£€æŸ¥Issueæ—¶é—´çº¿äº‹ä»¶...")
              try:
                  issue_timeline_url = f"https://api.github.com/repos/{github_repo}/issues/{issue_number}/timeline"
                  req = urllib.request.Request(issue_timeline_url)
                  req.add_header('Authorization', f'token {github_token}')
                  req.add_header('Accept', 'application/vnd.github.v3+json')
                  
                  with urllib.request.urlopen(req) as response:
                      issue_timeline_data = json.loads(response.read().decode())
                  
                  for event in issue_timeline_data:
                      if (event.get('event') == 'connected_event' and 
                          event.get('source', {}).get('issue', {}).get('number') == int(pr_number)):
                          is_linked = True
                          link_reason = "Issueæ—¶é—´çº¿æ˜¾ç¤ºå·²è¿æ¥"
                          print(f"âœ… æ£€æµ‹åˆ°å…³è”ï¼š{link_reason}")
                          break
              except Exception as e:
                  print(f"âš ï¸ æ£€æŸ¥Issueæ—¶é—´çº¿æ—¶å‡ºé”™: {str(e)}")
          
          # å†™å…¥è¾“å‡º
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"is_linked={'true' if is_linked else 'false'}\n")
              f.write(f"link_reason={link_reason}\n")
          
          if is_linked:
              print(f"âœ… PRå·²ç»å…³è”åˆ°Issue #{issue_number} ({link_reason})")
          else:
              print(f"â„¹ï¸ PRå°šæœªå…³è”åˆ°Issue #{issue_number}ï¼Œå°†è‡ªåŠ¨æ·»åŠ å…³è”")
          EOF

      - name: Auto link PR to Issue
        id: link-issue
        if: ${{ steps.check-link.outputs.is_linked == 'false' }}
        env:
          CURRENT_BODY: ${{ github.event.pull_request.body }}
          ISSUE_NUMBER: ${{ steps.check-title.outputs.issue_number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ”— å¼€å§‹è‡ªåŠ¨å…³è”PR #$PR_NUMBER åˆ°Issue #$ISSUE_NUMBER"
          
          # ä½¿ç”¨ Python è¿›è¡Œå®‰å…¨çš„å­—ç¬¦ä¸²å¤„ç†å’Œ API è°ƒç”¨
          python3 << 'EOF'
          import os
          import json
          import urllib.request
          import urllib.error
          import sys
          
          current_body = os.environ.get('CURRENT_BODY', '')
          issue_number = os.environ['ISSUE_NUMBER']
          pr_number = os.environ['PR_NUMBER']
          github_token = os.environ['GITHUB_TOKEN']
          github_repo = os.environ['GITHUB_REPOSITORY']
          
          # æ„å»ºå…³è”æ–‡æœ¬
          link_text = f"Closes #{issue_number}"
          
          # æ„å»ºæ–°çš„PRæè¿°
          if not current_body or current_body.strip() == '' or current_body == 'null':
              new_body = link_text
          else:
              new_body = f"{link_text}\n\n{current_body}"
          
          print("æ–°çš„PRæè¿°: (å†…å®¹å·²å®‰å…¨å¤„ç†)")
          
          # å‡†å¤‡APIè¯·æ±‚æ•°æ®
          data = {
              'body': new_body
          }
          
          # ä½¿ç”¨GitHub APIæ›´æ–°PRæè¿°
          api_url = f"https://api.github.com/repos/{github_repo}/pulls/{pr_number}"
          
          try:
              req = urllib.request.Request(api_url, method='PATCH')
              req.add_header('Authorization', f'token {github_token}')
              req.add_header('Accept', 'application/vnd.github.v3+json')
              req.add_header('Content-Type', 'application/json')
              
              json_data = json.dumps(data).encode('utf-8')
              
              with urllib.request.urlopen(req, data=json_data) as response:
                  response_data = json.loads(response.read().decode())
              
              print(f"âœ… æˆåŠŸå…³è”PR #{pr_number} åˆ°Issue #{issue_number}")
              
              # å†™å…¥è¾“å‡º
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("link_added=true\n")
                  
          except urllib.error.HTTPError as e:
              print(f"âŒ å…³è”å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : {e.code}")
              try:
                  error_response = e.read().decode()
                  print(f"é”™è¯¯å“åº”: {error_response}")
              except:
                  pass
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("link_added=false\n")
              sys.exit(1)
              
          except Exception as e:
              print(f"âŒ å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("link_added=false\n")
              sys.exit(1)
          EOF

      - name: Success message
        env:
          ISSUE_NUMBER: ${{ steps.check-title.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.check-issue.outputs.issue_title }}
          IS_LINKED: ${{ steps.check-link.outputs.is_linked }}
          LINK_REASON: ${{ steps.check-link.outputs.link_reason }}
          LINK_ADDED: ${{ steps.link-issue.outputs.link_added }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # ä½¿ç”¨ Python è¿›è¡Œå®‰å…¨çš„å­—ç¬¦ä¸²å¤„ç†
          python3 << 'EOF'
          import os
          
          issue_number = os.environ['ISSUE_NUMBER']
          issue_title = os.environ.get('ISSUE_TITLE', '')
          is_linked = os.environ['IS_LINKED']
          link_reason = os.environ.get('LINK_REASON', '')
          link_added = os.environ.get('LINK_ADDED', '')
          pr_title = os.environ['PR_TITLE']
          
          print("ğŸ‰ PRæ ‡é¢˜æ ¡éªŒé€šè¿‡ï¼")
          print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
          print(f"ğŸ“‹ PRæ ‡é¢˜: {pr_title}")
          print(f"ğŸ”— å…³è”Issue: #{issue_number}")
          print(f"ğŸ“ Issueæ ‡é¢˜: {issue_title}")
          print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
          
          if is_linked == "true":
              print(f"âœ… å…³è”çŠ¶æ€: å·²å…³è” ({link_reason})")
              print("ğŸ’¡ æ— éœ€é‡å¤æ“ä½œï¼ŒPRå·²æ­£ç¡®å…³è”åˆ°Issue")
          elif link_added == "true":
              print("âœ… å…³è”çŠ¶æ€: å·²è‡ªåŠ¨æ·»åŠ å…³è”")
              print("ğŸ“ PRå·²è‡ªåŠ¨å…³è”åˆ°Issueï¼Œåˆå¹¶PRæ—¶å°†è‡ªåŠ¨å…³é—­å¯¹åº”çš„Issue")
          else:
              print("âš ï¸ å…³è”çŠ¶æ€: å…³è”å¤±è´¥")
          EOF