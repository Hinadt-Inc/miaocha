name: PR CI

on:
  pull_request:
    branches: [ dev ]

jobs:
  # 检查是否应该跳过 CI
  check-skip-ci:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip-check.outputs.should_skip }}
    steps:
      - name: Check if CI should be skipped
        id: skip-check
        run: |
          if echo '${{ toJson(github.event.pull_request.labels.*.name) }}' | grep -q '"no ci"'; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "🚫 CI 被跳过：发现 'no ci' 标签"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "✅ CI 将正常执行"
          fi

  # 跳过 CI 的说明 job
  skip-ci-info:
    runs-on: ubuntu-latest
    needs: check-skip-ci
    if: ${{ needs.check-skip-ci.outputs.should_skip == 'true' }}
    steps:
      - name: CI Skipped
        run: |
          echo "🚫 CI 构建已跳过"
          echo "原因：PR 包含 'no ci' 标签"
          echo "如需重新运行 CI，请移除该标签"

  pr-ci:
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # 添加并发控制，同一PR的新提交会取消之前的运行
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    
    # 如果PR包含 "no ci" label，则跳过整个工作流
    if: ${{ needs.check-skip-ci.outputs.should_skip == 'false' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 需要完整历史用于覆盖率比较
          submodules: true  # 自动签出所有子模块

      - name: Update submodules to latest
        run: |
          git submodule update --remote --recursive
          echo "Updated submodules:"
          git submodule status

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure system for Doris
        run: |
          # 关闭swap分区
          sudo swapoff -a

          # 设置系统参数
          sudo sysctl -w vm.max_map_count=2000000
          sudo sysctl -w vm.swappiness=0
          sudo sysctl -w fs.file-max=655360

          # 验证设置
          echo "=== System Configuration ==="
          echo "Swap status:"
          swapon --show
          echo "vm.max_map_count: $(cat /proc/sys/vm/max_map_count)"
          echo "vm.swappiness: $(cat /proc/sys/vm/swappiness)"
          echo "fs.file-max: $(cat /proc/sys/fs/file-max)"

      - name: Run unit tests and integration tests
        run: mvn clean verify

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./miaocha-server/target/site/jacoco-aggregate/jacoco.xml
          flags: tests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: '41b29712-7ac0-4837-ba28-e3a755b03952'
          verbose: true
          # 添加更多配置确保更好的覆盖率比较
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          override_commit: ${{ github.event.pull_request.head.sha }}
          override_branch: ${{ github.event.pull_request.head.ref }}

