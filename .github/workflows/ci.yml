name: PR CI

on:
  pull_request:
    branches: [ dev ]

jobs:
  # æ£€æŸ¥æ˜¯å¦åº”è¯¥è·³è¿‡ CI
  check-skip-ci:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip-check.outputs.should_skip }}
    steps:
      - name: Check if CI should be skipped
        id: skip-check
        run: |
          if echo '${{ toJson(github.event.pull_request.labels.*.name) }}' | grep -q '"no ci"'; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "ğŸš« CI è¢«è·³è¿‡ï¼šå‘ç° 'no ci' æ ‡ç­¾"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "âœ… CI å°†æ­£å¸¸æ‰§è¡Œ"
          fi

  # è·³è¿‡ CI çš„è¯´æ˜ job
  skip-ci-info:
    runs-on: ubuntu-latest
    needs: check-skip-ci
    if: ${{ needs.check-skip-ci.outputs.should_skip == 'true' }}
    steps:
      - name: CI Skipped
        run: |
          echo "ğŸš« CI æ„å»ºå·²è·³è¿‡"
          echo "åŸå› ï¼šPR åŒ…å« 'no ci' æ ‡ç­¾"
          echo "å¦‚éœ€é‡æ–°è¿è¡Œ CIï¼Œè¯·ç§»é™¤è¯¥æ ‡ç­¾"

  pr-ci:
    runs-on: ubuntu-latest
    needs: check-skip-ci
    # æ·»åŠ å¹¶å‘æ§åˆ¶ï¼ŒåŒä¸€PRçš„æ–°æäº¤ä¼šå–æ¶ˆä¹‹å‰çš„è¿è¡Œ
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    
    # å¦‚æœPRåŒ…å« "no ci" labelï¼Œåˆ™è·³è¿‡æ•´ä¸ªå·¥ä½œæµ
    if: ${{ needs.check-skip-ci.outputs.should_skip == 'false' }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ç”¨äºè¦†ç›–ç‡æ¯”è¾ƒ
          submodules: true  # è‡ªåŠ¨ç­¾å‡ºæ‰€æœ‰å­æ¨¡å—

      - name: Update submodules to latest
        run: |
          git submodule update --remote --recursive
          echo "Updated submodules:"
          git submodule status

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure system for Doris
        run: |
          # å…³é—­swapåˆ†åŒº
          sudo swapoff -a

          # è®¾ç½®ç³»ç»Ÿå‚æ•°
          sudo sysctl -w vm.max_map_count=2000000
          sudo sysctl -w vm.swappiness=0
          sudo sysctl -w fs.file-max=655360

          # éªŒè¯è®¾ç½®
          echo "=== System Configuration ==="
          echo "Swap status:"
          swapon --show
          echo "vm.max_map_count: $(cat /proc/sys/vm/max_map_count)"
          echo "vm.swappiness: $(cat /proc/sys/vm/swappiness)"
          echo "fs.file-max: $(cat /proc/sys/fs/file-max)"

      - name: Run unit tests and integration tests
        run: mvn clean verify

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./miaocha-server/target/site/jacoco-aggregate/jacoco.xml
          flags: tests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: '41b29712-7ac0-4837-ba28-e3a755b03952'
          verbose: true
          # æ·»åŠ æ›´å¤šé…ç½®ç¡®ä¿æ›´å¥½çš„è¦†ç›–ç‡æ¯”è¾ƒ
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          override_commit: ${{ github.event.pull_request.head.sha }}
          override_branch: ${{ github.event.pull_request.head.ref }}

