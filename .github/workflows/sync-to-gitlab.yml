name: Sync to Internal GitLab

on:
  push:
    branches: [ dev, main ]

jobs:
  sync-to-gitlab:
    runs-on: arc-runner-set
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full Git history to ensure correct sync
          submodules: true  # Include submodules

      - name: Configure Git
        run: |
          echo "ðŸ”§ Configure Git user info..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add GitLab remote and sync
        run: |
          echo "ðŸ”— Add GitLab remote..."
          
          # Validate credentials
          if [ -z "${{ secrets.GITLAB_USERNAME }}" ] || [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "âŒ GitLab credentials not configured; check GitHub Secrets"
            exit 1
          fi
          
          # URL-encode credentials (handle special characters)
          GITLAB_USERNAME=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${{ secrets.GITLAB_USERNAME }}', safe=''))")
          GITLAB_TOKEN=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${{ secrets.GITLAB_TOKEN }}', safe=''))")
          
          # Build GitLab URL with credentials
          GITLAB_URL="http://${GITLAB_USERNAME}:${GITLAB_TOKEN}@git.hinadt.com/middle-software/log-manage-system.git"
          
          echo "ðŸ” GitLab URL format check completed"
          
          # Add GitLab remote
          git remote add gitlab "$GITLAB_URL" || git remote set-url gitlab "$GITLAB_URL"
          git fetch gitlab
          
          # Get current branch name
          CURRENT_BRANCH="${{ github.ref_name }}"
          echo "ðŸ“¤ Current branch: $CURRENT_BRANCH"
          
          # Push to GitLab branch
          echo "ðŸš€ Start syncing to GitLab..."
          git push gitlab "$CURRENT_BRANCH:$CURRENT_BRANCH" --force-with-lease
          
          echo "âœ… Sync completed! Branch $CURRENT_BRANCH has been synced to internal GitLab"

      - name: Notify sync result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… GitLab Sync Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Sync Info" >> $GITHUB_STEP_SUMMARY
            echo "- **Source branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Target repo**: git.hinadt.com/middle-software/log-manage-system" >> $GITHUB_STEP_SUMMARY
            echo "- **Target branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Sync time**: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "Code has been synced to internal GitLab. GitLab CI/CD will build and deploy images automatically." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ GitLab Sync Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” Possible causes" >> $GITHUB_STEP_SUMMARY
            echo "1. Connectivity issue to GitLab server" >> $GITHUB_STEP_SUMMARY
            echo "2. Invalid or expired credentials" >> $GITHUB_STEP_SUMMARY
            echo "3. Insufficient permissions on target repo" >> $GITHUB_STEP_SUMMARY
            echo "4. Network issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ž How to fix" >> $GITHUB_STEP_SUMMARY
            echo "Check credentials in GitHub Secrets and contact Ops to verify internal GitLab status." >> $GITHUB_STEP_SUMMARY
          fi 
