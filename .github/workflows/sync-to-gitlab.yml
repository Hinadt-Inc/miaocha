name: Sync to Internal GitLab

on:
  push:
    branches: [ dev, main ]

jobs:
  sync-to-gitlab:
    runs-on: arc-runner-set
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´çš„ Git åŽ†å²ï¼Œç¡®ä¿èƒ½æ­£ç¡®åŒæ­¥
          submodules: true  # åŒ…å«å­æ¨¡å—

      - name: Configure Git
        run: |
          echo "ðŸ”§ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add GitLab remote and sync
        run: |
          echo "ðŸ”— æ·»åŠ  GitLab è¿œç¨‹ä»“åº“..."
          
          # æ£€æŸ¥è®¤è¯ä¿¡æ¯æ˜¯å¦å­˜åœ¨
          if [ -z "${{ secrets.GITLAB_USERNAME }}" ] || [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "âŒ GitLab è®¤è¯ä¿¡æ¯æœªé…ç½®ï¼Œè¯·æ£€æŸ¥ GitHub Secrets"
            exit 1
          fi
          
          # URL ç¼–ç è®¤è¯ä¿¡æ¯ï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          GITLAB_USERNAME=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${{ secrets.GITLAB_USERNAME }}', safe=''))")
          GITLAB_TOKEN=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${{ secrets.GITLAB_TOKEN }}', safe=''))")
          
          # æž„å»ºåŒ…å«è®¤è¯ä¿¡æ¯çš„ GitLab URL
          GITLAB_URL="http://${GITLAB_USERNAME}:${GITLAB_TOKEN}@git.hinadt.com/middle-software/log-manage-system.git"
          
          echo "ðŸ” GitLab URL æ ¼å¼æ£€æŸ¥å®Œæˆ"
          
          # æ·»åŠ  GitLab è¿œç¨‹ä»“åº“
          git remote add gitlab "$GITLAB_URL" || git remote set-url gitlab "$GITLAB_URL"
          git fetch gitlab
          
          # èŽ·å–å½“å‰åˆ†æ”¯å
          CURRENT_BRANCH="${{ github.ref_name }}"
          echo "ðŸ“¤ å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
          
          # æŽ¨é€åˆ° GitLab å¯¹åº”åˆ†æ”¯
          echo "ðŸš€ å¼€å§‹åŒæ­¥åˆ° GitLab..."
          git push gitlab "$CURRENT_BRANCH:$CURRENT_BRANCH" --force-with-lease
          
          echo "âœ… åŒæ­¥å®Œæˆï¼åˆ†æ”¯ $CURRENT_BRANCH å·²æˆåŠŸåŒæ­¥åˆ°å†…éƒ¨ GitLab"

      - name: Notify sync result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… GitLab åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ åŒæ­¥ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "- **æºåˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ç›®æ ‡ä»“åº“**: git.hinadt.com/middle-software/log-manage-system" >> $GITHUB_STEP_SUMMARY
            echo "- **ç›®æ ‡åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æäº¤ SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **åŒæ­¥æ—¶é—´**: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ åŽç»­æµç¨‹" >> $GITHUB_STEP_SUMMARY
            echo "ä»£ç å·²æˆåŠŸåŒæ­¥åˆ°å†…éƒ¨ GitLabï¼ŒGitLab CI/CD å°†è‡ªåŠ¨è§¦å‘é•œåƒæž„å»ºå’Œéƒ¨ç½²æµç¨‹ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ GitLab åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” å¯èƒ½çš„åŽŸå› " >> $GITHUB_STEP_SUMMARY
            echo "1. GitLab æœåŠ¡å™¨è¿žæŽ¥é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "2. è®¤è¯ä¿¡æ¯é”™è¯¯æˆ–è¿‡æœŸ" >> $GITHUB_STEP_SUMMARY
            echo "3. ç›®æ ‡ä»“åº“æƒé™ä¸è¶³" >> $GITHUB_STEP_SUMMARY
            echo "4. ç½‘ç»œè¿žæŽ¥é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ž è§£å†³æ–¹æ¡ˆ" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥ GitHub Secrets ä¸­çš„è®¤è¯ä¿¡æ¯ï¼Œå¹¶è”ç³»è¿ç»´å›¢é˜Ÿç¡®è®¤å†…éƒ¨ GitLab æœåŠ¡çŠ¶æ€ã€‚" >> $GITHUB_STEP_SUMMARY
          fi 
